@using System.Data
@using Common
@model object
@{
    DataRow dr = null;
    if (Model != null)
    {
        PageModel pageModel = Model as PageModel;

        if (pageModel.code==0)
        {
            DataTable dt = pageModel.data as DataTable;
            if (dt != null && dt.Rows.Count > 0)
            {
                dr = dt.Rows[0];
            }
        }
    }

}
@section scripts{
    <script>
        $(function () {
            var ajaxHelper = new AjaxHelper();

            layui.use(['laydate', 'jquery', 'layer', 'form', 'laytpl','element'], function () {
                var $ = layui.jquery, laydate = layui.laydate, layer = layui.layer, form = layui.form, laytpl = layui.laytpl ,element = layui.element;
                var start = {
                    min: laydate.now
                    , max: '2099-06-16 23:59:59'
                    , istoday: false
                    , choose: function (datas) {
                    end.min = datas; //开始日选好后，重置结束日的最小日期
                    end.start = datas //将结束日的初始值设定为开始日
                     }
                };

                var end = {
                    min: laydate.now
                  , max: '2099-06-16 23:59:59'
                  , istoday: true
                  , choose: function (datas) {
                      start.max = datas; //结束日选好后，重置开始日的最大日期
                  }
                };
                laydate.render({
                    elem: '#test1'
                });
                form.on('submit(save1)', function (data) {
                    var result = $('#Discount').val().match(/^(0(.\d+)?|1(\.0+)?)$/);
                    if (result == null) {
                        layer.open({
                            title: '提示', content: '折扣格式不正确!', time: 2000
                        });
                        return false;
                    }
                    var ddd = { str: JSON.stringify(data.field) };
                    ajaxHelper.post("/OrderSys/Order_AddEdits/", ddd, function (da) {
                        var jsonObj = JSON.parse(da);
                        if (jsonObj.result) {
                            layer.open({
                                title: '提示', content: jsonObj.data, time: 2000,
                                end: function () {
                                    var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                                    parent.layer.close(index);  // 关闭layer
                                }
                            });
                        }
                        else {
                            layer.open({
                                title: '提示', content: jsonObj.result
                            });
                        }

                    });
                    return false;
                });
                $(function () {
                    GetAllOrderPeopleInfos();
                    selectchanged("", "NewspaperName");
                });
                //绑定订户信息
                function GetAllOrderPeopleInfos() {
                    var ddd = { str: "" };
                    ajaxHelper.post("/OrderSys/GetAllOrderPeopleInfos/", ddd, function (da) {
                        var jsonObj = JSON.parse(da);
                        var getTpl3 = $("#OrderPeopleInfos").html()
                            , view3 = $("#OrderPeople");
                        if (jsonObj.code==0) {
                            if (jsonObj.data.length > 0) {
                                laytpl(getTpl3).render(jsonObj.data, function (a3) {
                                    $(view3).html(a3);
                                    var value = $("#OrderPeople").attr("tag");
                                    $("#OrderPeople option[value='" + value + "']").attr("selected", "selected");
                                });
                            }
                        }
                        form.render();
                    });
                }
                //绑定报纸信息
                function selectchanged(parentid, elem) {
                    var ddd = { str: parentid };
                    ajaxHelper.post("/BasicSys/GetAllDocInfo/", ddd, function (da) {
                        var jsonObj = JSON.parse(da);
                        var getTpl2 = $("#orginfo").html()
                            , view2 = $("#" + elem + "");
                        if (jsonObj.result) {
                            if (jsonObj.data.length > 0) {
                                laytpl(getTpl2).render(jsonObj.data, function (a2) {
                                    $(view2).html(a2);
                                    //设置选中值
                                    var value = $("#NewspaperName").attr("tag");
                                    $("#NewspaperName option[value='" + value + "']").attr("selected", "selected");
                                    //绑定价格
                                    document.getElementById("Price").value = $("#NewspaperName").find("option:selected").attr("tag");
                                });
                            }
                        }
                        form.render();
                    });
                }
                form.on('select(NewspaperName)', function (data) {
                    //console.log($("#NewspaperName").find("option:selected").attr("tag"));
                    document.getElementById("Price").value = $("#NewspaperName").find("option:selected").attr("tag");
                    nowprice();
                    return false;
                });
                //相关元素值变更时,刷新总价
                function nowprice()
                {
                    var result = $('#Discount').val().match(/^(0(.\d+)?|1(\.0+)?)$/);
                    if (result == null) {
                        layer.open({
                            title: '提示', content: '折扣格式不正确!', time: 2000
                        });
                        return false;
                    }
                    var dj = $('#Price').val();//单价
                    var Month = $('#Month').val();//月数
                    var OrderNumber = $('#OrderNumber').val();//订购份数
                    var Discount = $('#Discount').val();//折扣
                    document.getElementById("FullPrice").value = dj * Month * OrderNumber * Discount;
                }
                form.render();
            });
        });
    </script>
}
<script id="orginfo" type="text/html">
    <option value="" tag="0">请选择</option>
    {{#  layui.each(d, function(index, item){ }}
    <option value="{{item.BKDH}}" tag="{{item.PRICE}}">{{item.DOCNAME}}</option>
    {{#  }); }}
</script>
<script id="OrderPeopleInfos" type="text/html">
    <option value="">请选择</option>
    {{#  layui.each(d, function(index, item){ }}
    <option value="{{item.ID}}">{{item.UnitName}}</option>
    {{#  }); }}
</script>
<form class="layui-form layui-form-pane" style="margin-left: 20px;margin-top:20px;" action="" method="get" id="mainform">
    <input type="hidden" name="ID" value="@(dr == null ? "" : dr["ID"]._ToStrTrim())" />
    <input type="hidden" name="MGuid" value="@(dr == null ? "" : dr["NGUID"]._ToStrTrim())" />
    <input type="hidden" name="CostID" value="@(dr == null ? "" : dr["CostID"]._ToStrTrim())" />
    <div class=" layui-form-item">
        <label class="layui-form-label">订户</label>
        <div class="layui-input-inline">
            <select id="OrderPeople" name="OrderPeople" tag="@(dr == null ? "" : dr["PersonID"]._ToStrTrim())"></select>
        </div>
        <label class="layui-form-label">报刊名称</label>
        <div class="layui-input-inline">
            <select id="NewspaperName"  lay-filter="NewspaperName"  name="NewspaperName" tag="@(dr == null ? "" : dr["BKDH"]._ToStrTrim())">
            </select>
        </div>        
    </div>
    <div class=" layui-form-item">
        <label class="layui-form-label">单价</label>
        <div class="layui-input-inline">
            <input type="text" id="Price" name="Price" value="0" readonly placeholder=""onchange="javascript: nowprice();"autocomplete="off" class="layui-input" maxlength="50">
        </div>
        <label class="layui-form-label">订阅月数</label>
        <div class="layui-input-inline">
            <input type="text" id="Month" onkeyup="this.value=this.value.replace(/[^\d]/g,'') " value="@(dr == null ? "" : dr["OrderMonths"]._ToStrTrim())" name="Month" placeholder=""onchange="javascript: nowprice();" autocomplete="off" class="layui-input" maxlength="50">
        </div>
    </div>
    <div class=" layui-form-item">     
        <label class="layui-form-label">订购份数</label>
        <div class="layui-input-inline">
            <input type="text" id="OrderNumber"onkeyup="this.value=this.value.replace(/[^\d]/g,'')" name="OrderNumber" value="@(dr == null ? "" : dr["OrderNum"]._ToStrTrim())" onchange="javascript: nowprice();"placeholder="" autocomplete="off" class="layui-input" maxlength="50">
        </div>
        <label class="layui-form-label">总价</label>
        <div class="layui-input-inline">
            <input type="text" id="FullPrice" name="FullPrice" value="@(dr == null ? "" : dr["Money"]._ToStrTrim())" readonly placeholder="" autocomplete="off" class="layui-input" maxlength="50">
        </div>
    </div>
    <div class=" layui-form-item">
        <label class="layui-form-label">折扣</label>
        <div class="layui-input-inline">
            <input type="text" id="Discount" name="Discount" value="@(dr == null ? 1 : 
                    dr["Money"]._ToDecimal()/(dr["OrderNum"]._ToInt32()*dr["OrderMonths"]._ToInt32()*dr["Price"]._ToDecimal()))" 
                   placeholder="" autocomplete="off" onchange="nowprice()" class="layui-input" maxlength="50">
        </div>
        <label class="layui-form-label">已缴金额</label>
        <div class="layui-input-inline">
            <input type="text" id="MoneyPayed" name="MoneyPayed" value="@(dr == null ? "" : dr["MoneyPayed"]._ToStrTrim())" placeholder="" autocomplete="off" class="layui-input" maxlength="50">
        </div>
    </div>
    <div class=" layui-form-item">
        <label class="layui-form-label" hidden>缴费</label>
        <div class="layui-input-inline" hidden>
            <input type="text" id="Pay" name="Pay" value="0" placeholder="" autocomplete="off" class="layui-input" maxlength="50">
        </div>
        <button class="layui-btn layui-btn-warm" lay-filter="save1" lay-submit="" data-type="save">
            <i class="layui-icon">&#xe618;</i> 确定
        </button>
        <button class="layui-btn layui-btn-danger" onclick="javascript: mvccloseall();">
            <i class="layui-icon">&#x1006;</i> 取消
        </button>
    </div>
    
</form>
